## 모던 자바 인 액션 1장

---

### 1장. 무슨 일이 일어나고 있는가?

#### 1.2 자바8 설계의 밑바탕을 이루는 3가지 프로그래밍 개념

1. 스트림 처리

스트림이란?

- 한 번에 한 개씩 만들어지는 연속적인 데이터 항목들의 모임.
- 기존에는 한 번에 한 항목을 처리했지만, 추상화시켜 일련의 스트림으로 만들어 한 번에 처리가능.
- 스트림 파이프라인을 이용해 입력 부분을 여러 CPU 코어에 쉽게 나눠줄 수 있음. (**공짜로 병렬성을 얻을 수 있음)**



2. 동작 파라미터화로 메소드에 코드 전달하기

- 메소드를 다른 메소드의 인수로 넘겨주는 기능 제공 : **동작 파라미터화**



3. 병렬성과 공유 가변 데이터

- 병렬성을 공짜로 얻기 위해서는 어떻게 해야할까?

  다른 코드와 동시에 실행하더라도 안전하게 실행할 수 있는 코드를 만들어야한다.

- 가변 데이터에 접근하지 않아야한다.(mutable data)

- 이러한 순수 함수를 side-effect 없는 함수, stateless함수라고 부른다.

- synchronized를 사용하면 되지만, 이는 시스템 성능에 악영향을 끼친다.

- 스트림을 사용하면 쉽게 병렬성을 활용할 수 있다.

- 멀티 코어에서는 코드가 순차적으로 실행되어야해서 병렬이라는 목적이 무너지고, 훨씬 더 비싼 성능 대가를 치룰 수 있다.

```
immutable data, 메소드, 함수 코드를 다른 메소드로 전달하는 기능이 함수형 프로그래밍 패러다임의 핵심이다.
```



#### 1.3 자바함수

일급시민 : 프로그램을 실행하는 동안 모든 구조체를 자유롭게 전달할 수 있음 (ex: 값)

이급시민 : 전달 불 가능(ex : 메소드, 클래스)

값 : int, double, 객체(클래스의 인스턴스를 가리키기 때문에 값에 속함) -> String, new Integer, new HashMap, 배열 등등



> 이 얘기가 왜나오는데??

만약 런타임시점에 이급시민인 메소드를 전달할 수 있다면??

- 프로그래밍이 수월해진다.
- 그래서 자바8에서는 그런 기능을 추가한다.



#### 1.3.1 메소드와 람다를 일급 시민으로

1. 메소드 참조

   자바8에서는 더이상 메소드가 이급 시민이 아닌 일급시민이다.

2. 람다 : 익명함수

   람다를 포함하여 함수도 마찬가지로 값으로 취급 가능



```
프레디케이트(Predicate)
인수로 값을 받아 true, false를 반환하는 함수
```

```
for-each 방식으로 각 요소를 반복하면서 작업을 수행 : 외부 반복
스트림 API를 사용해 내부에서 모든 데이터 처리 : 내부 반복
```



#### 1.4.1 멀티스레딩은 어렵다

스트림 API를 사용함으로써 `컬렉션을 처리하면서 발생하는 모호함과 반복적인 코드문제`, `멀티코어 활용 어려움`이라는 두 가지 문제를 모두 해결



**컬렉션을 필터링할 수 있는 가장 빠른 방법**

- 컬렉션을 스트림으로 바꾸고, 병렬로 처리한 후, 리스트로 다시 복원

  쪼개고, 연산하고, 결과를 합친다.

- .stream() vs .parallelstream()

  parallelstream은 공유된 thread pool을 사용하기 때문에 성능장애를 일으킬 수 있다.

  상황에 맞게 사용해야한다.

  간단하게만 요약하자면, 

  parallelstream은 내부적으로 **forkJoinPool** 이라는 쓰레드 풀의 일종을 사용하고있는데,

  이는 분할정복 알고리즘과 비슷하다.

  

  ExecutroService의 구현체이며, 각 thread들이 개별 큐를 가지게 되며, 자신에게 할당된 task가 없으면 다른 작업중인 task를 가져와 처리함으로써 CPU자원이 놀지않고 최적의 성능을 낼 수 있다.

  

  작업을 균등하게 가져오기위해 Spliterator의 trySplit을 사용하는데, 이 분할되는 작업의 단위가 균등하게 나누어져야하며, 나누어지는 작업에 대한 비용이 높지 않아야 순차적 방식보다 효율적으로 이루어질 수 있다.

  array, arrayList와 같이 정확한 전체 사이즈를 알 수 있는 경우에는 분할처리가 빠르고 비용이 적게 들지만, LinkedList라면 별다른 효과를 찾기 어렵다.

  

  또한, 병렬로 처리되는 작업이 독립적이지 않다면, 수행 성능에 영향이 있을 수 있다.

  stream의 중간 단계 연산 중  `sorted, distinct` 같은 작업 수행시 내부적으로 상태에 대한 변수를 각 작업들이 공유(synchronized)하게 되어있다. 이러한 경우 순차적 실행이 효과적이다.

  

  **결론**

  ForkJoinPool 방식을 사용하기 때문에 분할이 잘 이루어질 수 있는 데이터 구조이거나, 작업이 독립적이면서 CPU 사용이 높은 작업에 적합하다.

  

  https://m.blog.naver.com/PostView.nhn?blogId=tmondev&logNo=220945933678&proxyReferer=https:%2F%2Fwww.google.com%2F

  http://gee.cs.oswego.edu/dl/html/StreamParallelGuidance.html



#### 1.5 디폴트 메소드와 자바 모듈

- 디폴트 메소드를 제공함으로써, 모든 기능을 새로 재정의하지 않아도 된다.



#### 1.6 함수형 프로그래밍이 가져온 유용한 아이디어

- Optional

